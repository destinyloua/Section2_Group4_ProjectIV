package testing;

import java.nio.ByteBuffer;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

import back_end.SocketHandler;

public class ImageReceiver {
	
	public void Receive(String savedFile) {
		try {
			//Get img size
			byte[] receivedImgSize = SocketHandler.ReceiveData();
			ByteBuffer read = ByteBuffer.wrap(receivedImgSize);
			int imageSize = read.getInt();
			System.out.println("Image received: " + imageSize + " bytes");
			
			int chunkSize = 32768;
			int dataSize = chunkSize -4;
			int totalChunk = (int) Math.ceil((double) imageSize/dataSize);
			
			byte[] imgData = new byte[imageSize];
			
			for(int i=0;i<totalChunk;i++) {
				byte[] receivedChunk = SocketHandler.ReceiveData();
				read = ByteBuffer.wrap(receivedChunk);
				
				System.out.println("Chunk #"+read.getInt()+": " + receivedChunk.length + " bytes");
				
				int start = i * (chunkSize - 4);
				//Copy received img data into img bytes array (Exclude the chunk number at first 4 bytes)
				System.arraycopy(receivedChunk, 4, imgData, start, receivedChunk.length - 4);
				System.out.println(receivedChunk.length - 4 + " bytes is coppied into imgData");
			}
			
			Path imagePath = Paths.get(savedFile);
			Files.write(imagePath, imgData);
			System.out.println("Image is saved at "+ savedFile);
		}
		catch (Exception e) {
			e.printStackTrace();
		}

	}

	public static void main(String[] args) {
		// TODO Auto-generated method stub
		SocketHandler.MakeConnection(27000);
		ImageReceiver receiver = new ImageReceiver();
		receiver.Receive("Test.jpg");
	}

}
